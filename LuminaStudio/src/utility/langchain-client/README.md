# LangChain Client (Agent Factory) æ¶æ„æ–‡æ¡£

**LangChain Client** æ˜¯ LuminaStudio çš„æ ¸å¿ƒ AI å¼•æ“ï¼Œè¿è¡Œåœ¨ Electron çš„ **Utility Process**ï¼ˆç‹¬ç«‹è¿›ç¨‹ï¼‰ä¸­ã€‚

å®ƒé‡‡ç”¨ **å·¥å‚æ¨¡å¼ (Factory Pattern)** å’Œ **LangGraph** æ¶æ„ï¼Œè´Ÿè´£ç®¡ç† AI Agent çš„ç”Ÿå‘½å‘¨æœŸã€ä»»åŠ¡ç¼–æ’ã€å·¥å…·è°ƒç”¨ä»¥åŠä¸ä¸»è¿›ç¨‹/æ¸²æŸ“è¿›ç¨‹çš„æµå¼é€šä¿¡ã€‚

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„è®¾è®¡

è¯¥ç³»ç»Ÿä¸å†æ˜¯ä¸€ä¸ªç®€å•çš„ LangChain è°ƒç”¨å°è£…ï¼Œè€Œæ˜¯ä¸€ä¸ªåˆ†å±‚çš„ **Agent å·¥å‚**ï¼š

| å±‚çº§        | ç›®å½•       | èŒè´£                                                                                                    |
| :---------- | :--------- | :------------------------------------------------------------------------------------------------------ |
| **Manager** | `manager/` | **ç®¡ç†è€…**ã€‚è´Ÿè´£ IPC é€šä¿¡ã€Agent ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆåˆ›å»º/é”€æ¯ï¼‰ã€è¯·æ±‚è°ƒåº¦ä¸ä¸­æ–­æ§åˆ¶ã€‚                        |
| **Factory** | `factory/` | **è£…é…è½¦é—´**ã€‚è´Ÿè´£åœ¨è¿è¡Œæ—¶æ ¹æ®é…ç½®ï¼ˆæ¨¡å‹IDã€Keyã€å·¥å…·é…ç½®ï¼‰ç»„è£…å‡ºå¯è¿è¡Œçš„ Agent Runtimeã€‚               |
| **Models**  | `models/`  | **è“å›¾ (Blueprints)**ã€‚å®šä¹‰ LangGraph çŠ¶æ€æœºå›¾è°±ï¼ˆStateGraphï¼‰ã€‚å†³å®šäº† Agent å¦‚ä½•æ€è€ƒã€å¾ªç¯å’Œå¤„ç†æ•°æ®ã€‚ |
| **Nodes**   | `nodes/`   | **å·¥äºº (Workers)**ã€‚å¯å¤ç”¨çš„å…·ä½“ä¸šåŠ¡é€»è¾‘èŠ‚ç‚¹ã€‚ä¾‹å¦‚ï¼šæ‰§è¡ŒçŸ¥è¯†åº“æ£€ç´¢ã€æ‰§è¡Œä»£ç è§£é‡Šå™¨ç­‰ã€‚                  |
| **Tools**   | `tools/`   | **å·¥å…·åŒ…è£…**ã€‚å°† Nodes åŒ…è£…ä¸º LangChain æ ‡å‡† Tool å¯¹è±¡ï¼Œä¾› LLM è¿›è¡Œè¯­ä¹‰è°ƒç”¨ã€‚                           |

---

## ğŸ“‚ ç›®å½•ç»“æ„è¯´æ˜

```
src/utility/langchain-client/
â”œâ”€â”€ index.ts           # å…¥å£æ–‡ä»¶ï¼Œå¯¼å‡º setupLangchainClient
â”œâ”€â”€ types.ts           # å†…éƒ¨ç±»å‹å®šä¹‰
â”œâ”€â”€ model-factory.ts   # LLM å®ä¾‹æ„å»ºå·¥å‚ (ChatOpenAI)
â”‚
â”œâ”€â”€ manager/           # ğŸŸ¢ ç®¡ç†å±‚
â”‚   â””â”€â”€ agent-manager.ts  # AgentManager ç±»ï¼šå¤„ç† invoke, abort, ç»´æŠ¤å®ä¾‹æ± 
â”‚
â”œâ”€â”€ factory/           # ğŸŸ¡ ç»„è£…å±‚
â”‚   â””â”€â”€ index.ts          # createAgentRuntimeï¼šç»„è£… Model + Tools
â”‚
â”œâ”€â”€ models/            # ğŸ”µ æ¨¡å‹/å›¾è°±å±‚
â”‚   â”œâ”€â”€ index.ts          # æ¨¡å‹æ³¨å†Œè¡¨
â”‚   â””â”€â”€ knowledge-qa/     # [ç¤ºä¾‹] çŸ¥è¯†åº“é—®ç­”æ¨¡å‹
â”‚       â”œâ”€â”€ graph.ts      # LangGraph çŠ¶æ€æœºå®šä¹‰ (æ ¸å¿ƒæµå¼é€»è¾‘)
â”‚       â”œâ”€â”€ prompt.ts     # ç³»ç»Ÿæç¤ºè¯
â”‚       â””â”€â”€ index.ts      # æ¨¡å‹å®šä¹‰å¯¼å‡º
â”‚
â”œâ”€â”€ nodes/             # ğŸŸ£ ä¸šåŠ¡èŠ‚ç‚¹å±‚
â”‚   â””â”€â”€ knowledge/
â”‚       â””â”€â”€ knowledge-retrieval.node.ts # çŸ¥è¯†æ£€ç´¢çš„æ ¸å¿ƒé€»è¾‘ (fetch API)
â”‚
â””â”€â”€ tools/             # ğŸŸ  å·¥å…·å±‚
    â”œâ”€â”€ index.ts          # å·¥å…·æ„å»ºå…¥å£
    â””â”€â”€ retrieval-tool.ts # å°† knowledge-retrieval.node åŒ…è£…ä¸º Tool
```

---

## ğŸ”„ æ•°æ®æµä¸ç”Ÿå‘½å‘¨æœŸ

### 1. åˆå§‹åŒ–ä¸åˆ›å»º

1. **Main Process** å‘é€ `agent:create`ã€‚
2. **Manager** æ¥æ”¶è¯·æ±‚ï¼Œè°ƒç”¨ **Factory**ã€‚
3. **Factory** æ ¹æ®é…ç½®ï¼š
   - è°ƒç”¨ `model-factory` åˆ›å»º LLM å®ä¾‹ã€‚
   - è°ƒç”¨ `tools` åˆ›å»ºå·¥å…·åˆ—è¡¨ã€‚
   - ä» `models` è·å–å¯¹åº”çš„ Graph å®šä¹‰ã€‚
4. **Manager** å°†ç¼–è¯‘å¥½çš„ Graph ä¿å­˜åˆ° `agents` Map ä¸­ã€‚

### 2. è°ƒç”¨ä¸æ‰§è¡Œ (Invoke)

1. **Main Process** å‘é€ `agent:invoke` (åŒ…å« `requestId`, `input`, `history`)ã€‚
2. **Manager** æ‰¾åˆ°å¯¹åº” Agentï¼Œåˆ›å»º `AbortController`ï¼Œè°ƒç”¨ Graph çš„ `.stream()` æ–¹æ³•ã€‚
3. **Graph (`models/knowledge-qa/graph.ts`)** å¼€å§‹æ‰§è¡Œï¼š
   - å°†è¾“å…¥è½¬æ¢ä¸º LangChain Messageã€‚
   - LLM ç”Ÿæˆå›å¤ã€‚
   - **æµå¼å¤„ç†**ï¼šå®æ—¶æ•è· chunkï¼ŒåŒºåˆ†æ˜¯æ–‡æœ¬å¢é‡è¿˜æ˜¯å·¥å…·è°ƒç”¨ã€‚

### 3. äº‹ä»¶å‘å°„ (Events)

ç³»ç»Ÿé€šè¿‡ `emit` å‡½æ•°å‘ä¸»è¿›ç¨‹å‘é€æ ‡å‡†åŒ–äº‹ä»¶ï¼š

- `invoke:text-delta`: AI çš„æ–‡æœ¬æ€è€ƒ/å›ç­”æ‰“å­—æœºæ•ˆæœã€‚
- `invoke:node-start/result`: **ä¸“ç”¨èŠ‚ç‚¹äº‹ä»¶**ï¼ˆå¦‚çŸ¥è¯†æ£€ç´¢ï¼‰ï¼Œå‰ç«¯ç”¨ä¸“ç”¨ç»„ä»¶æ¸²æŸ“ã€‚
- `invoke:tool-start/result`: **é€šç”¨å·¥å…·äº‹ä»¶**ï¼Œå‰ç«¯ç”¨é€šç”¨å·¥å…·ç»„ä»¶æ¸²æŸ“ã€‚
- `invoke:finish`: å®Œæˆæˆ–é”™è¯¯ã€‚

---

## ğŸ§© Block æ¶ˆæ¯æ¶æ„

ä¸ºäº†æ”¯æŒå¯Œåª’ä½“äº¤äº’ï¼Œæˆ‘ä»¬æ‘’å¼ƒäº†çº¯æ–‡æœ¬æ¶ˆæ¯ï¼Œé‡‡ç”¨äº† **Blockï¼ˆå—ï¼‰** æ¶æ„ã€‚åç«¯æµå¼è¾“å‡ºçš„ç›®æ ‡æ˜¯æ„å»ºä»¥ä¸‹ Blockï¼š

1. **TextBlock**: æ™®é€šæ–‡æœ¬ã€‚
2. **ThinkingBlock**: æ€ç»´é“¾å†…å®¹ (Reasoning)ã€‚
3. **ToolBlock**: é€šç”¨å·¥å…·è°ƒç”¨ã€‚
4. **NodeBlock**: è¯­ä¹‰åŒ–èŠ‚ç‚¹æ‰§è¡Œï¼ˆæ ¸å¿ƒå·®å¼‚ç‚¹ï¼‰ã€‚
   - _ç‰¹ç‚¹_ï¼šåŒ…å« `nodeKind` (å¦‚ `knowledge_retrieval`) å’Œ `uiHint`ã€‚
   - _ä½œç”¨_ï¼šå‰ç«¯æ ¹æ® `nodeKind` æ¸²æŸ“ç‰¹å®šçš„ UI ç»„ä»¶ï¼ˆå¦‚ `KnowledgeSearchMessage`ï¼‰ï¼Œè€Œä¸æ˜¯é€šç”¨çš„ JSON æ ‘ã€‚
5. **MetaBlock**: Token ä½¿ç”¨é‡ç­‰å…ƒæ•°æ®ã€‚

---

## ğŸ› ï¸ å¦‚ä½•æ‰©å±•

### æ·»åŠ ä¸€ä¸ªæ–°æ¨¡å‹ (Graph)

1. åœ¨ `models/` ä¸‹æ–°å»ºç›®å½•ï¼ˆå¦‚ `code-interpreter/`ï¼‰ã€‚
2. åˆ›å»º `graph.ts`ï¼Œå®šä¹‰ `StateGraph`ã€‚
3. åœ¨ `models/index.ts` ä¸­æ³¨å†Œæ–°æ¨¡å‹ã€‚

### æ·»åŠ ä¸€ä¸ªæ–°å·¥å…·/èŠ‚ç‚¹

è¿™æ˜¯ä¸€ä¸ªå…¨æ ˆæµç¨‹ï¼Œéœ€è¦åç«¯ã€å…±äº«ç±»å‹å’Œå‰ç«¯é…åˆã€‚

#### 1. åç«¯å®ç° (Utility Process)

1. **ç¼–å†™ä¸šåŠ¡é€»è¾‘**ï¼šåœ¨ `nodes/` ä¸‹åˆ›å»º `xxx.node.ts`ã€‚è¿™æ˜¯ä¸€ä¸ªçº¯å‡½æ•°ï¼Œä¸ä¾èµ– LangChainã€‚
2. **åŒ…è£…ä¸ºå·¥å…·**ï¼šåœ¨ `tools/` ä¸‹åˆ›å»º `xxx-tool.ts`ï¼Œä½¿ç”¨ `tool()` å‡½æ•°åŒ…è£… Nodeã€‚
3. **æ³¨å†Œå·¥å…·**ï¼šåœ¨ `tools/index.ts` ä¸­æ·»åŠ åˆ°åˆ—è¡¨ã€‚
4. **å¤„ç†äº‹ä»¶**ï¼šåœ¨ `graph.ts` çš„æµå¼å¾ªç¯ä¸­ï¼Œæ‹¦æˆªè¯¥å·¥å…·çš„åç§°ï¼Œå‘é€ `node-start` å’Œ `node-result` äº‹ä»¶ã€‚

#### 2. å®šä¹‰åè®® (Shared Types)

åœ¨ `src/Public/ShareTypes/langchain-client.types.ts` ä¸­ï¼š

1. æ›´æ–° `LangchainClientNodeKind` è”åˆç±»å‹ï¼Œæ·»åŠ æ–°çš„èŠ‚ç‚¹ç±»å‹ï¼ˆä¾‹å¦‚ `'code_interpreter'`ï¼‰ã€‚
2. (å¯é€‰) å¦‚æœéœ€è¦ç‰¹æ®Šçš„è¾“å…¥/è¾“å‡ºç»“æ„ï¼Œå¯ä»¥å®šä¹‰å¯¹åº”çš„ Payload æ¥å£ã€‚

```typescript
// src/Public/ShareTypes/langchain-client.types.ts
export type LangchainClientNodeKind =
  | 'knowledge_retrieval'
  | 'code_interpreter' // âœ¨ æ–°å¢
  | 'tool'
  | 'final_answer'
```

#### 3. å‰ç«¯å®ç° (Renderer Process)

1. **åˆ›å»ºç»„ä»¶**ï¼šåœ¨ `src/renderer/src/views/.../ChatMain-Message/` ä¸‹åˆ›å»ºæ–°ç»„ä»¶ï¼ˆä¾‹å¦‚ `CodeInterpreterMessage.vue`ï¼‰ã€‚
2. **æ³¨å†Œè·¯ç”±**ï¼šåœ¨ `Index.vue` çš„æ¨¡æ¿ä¸­æ·»åŠ æ¸²æŸ“é€»è¾‘ã€‚

```vue
<!-- src/renderer/src/views/.../Index.vue -->
<template>
  <!-- ... -->

  <!-- âœ¨ æ–°å¢ï¼šä»£ç è§£é‡Šå™¨èŠ‚ç‚¹ -->
  <CodeInterpreterMessage
    v-else-if="block.type === 'node' && block.start.nodeKind === 'code_interpreter'"
    :node-block="block"
  />

  <!-- ... -->
</template>
```

---

## â“ å¸¸è§é—®é¢˜ (FAQ)

**Q: ä¸ºä»€ä¹ˆçŸ¥è¯†æ£€ç´¢ä¸ä½¿ç”¨ Tool äº‹ä»¶ï¼Ÿ**
A: å› ä¸ºçŸ¥è¯†æ£€ç´¢æ˜¯æ ¸å¿ƒä¸šåŠ¡ï¼Œå‰ç«¯æœ‰ä¸“é—¨è®¾è®¡çš„ `KnowledgeSearchMessage` ç»„ä»¶æ¥å±•ç¤ºå¼•ç”¨æ¥æºã€è·ç¦»åˆ†æ•°ç­‰è¯¦ç»†ä¿¡æ¯ã€‚ä½¿ç”¨ `node-start/result` äº‹ä»¶å¯ä»¥æºå¸¦ `uiHint`ï¼Œè®©å‰ç«¯ç²¾ç¡®æ¸²æŸ“ï¼Œè€Œé€šç”¨ `tool` äº‹ä»¶é€šå¸¸åªç”¨äºè°ƒè¯•æˆ–ç®€å•çš„ JSON å±•ç¤ºã€‚

**Q: Factory çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ**
A: å®ƒå®ç°äº†**é…ç½®é©±åŠ¨**ã€‚å‰ç«¯åªéœ€è¦ä¼ ä¸€ä¸ª JSON é…ç½®ï¼ˆæ¨¡å‹IDã€Keyã€å¼€å…³ï¼‰ï¼ŒFactory å°±èƒ½è‡ªåŠ¨ç»„è£…å‡ºåŒ…å«æ­£ç¡® Promptã€æ­£ç¡®å·¥å…·é›†å’Œæ­£ç¡® LLM å‚æ•°çš„ Agentï¼Œè€Œä¸éœ€è¦å†™æ­»ä»£ç ã€‚
